<div class="w-full bg-white p-10 rounded-xl shadow">

  <h1 class="text-3xl font-semibold mb-8">
    {{ isEdit ? 'Përditëso rezervimin' : 'Krijo rezervim' }}
  </h1>

  <form [formGroup]="form" (ngSubmit)="save()" class="space-y-10">

    <!-- =====================  SEKSIONI 1: KLIENTI ===================== -->
    <h2 class="text-xl font-semibold mb-3">Të dhënat e klientit</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- Numri Personal -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Numri personal *</mat-label>
        <input matInput formControlName="personalNumber">
        <button matSuffix mat-icon-button (click)="searchCustomer()">
          <mat-icon>search</mat-icon>
        </button>
      </mat-form-field>

      <!-- Emri -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Emri *</mat-label>
        <input matInput formControlName="firstName">
      </mat-form-field>

      <!-- Mbiemri -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Mbiemri *</mat-label>
        <input matInput formControlName="lastName">
      </mat-form-field>

      <!-- Telefoni -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Telefoni *</mat-label>
        <input matInput formControlName="phoneNumber">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Adresa *</mat-label>
        <input matInput formControlName="address">
       </mat-form-field>
    </div>


    <!-- =====================  SEKSIONI 2: REZERVIMI ===================== -->
    <h2 class="text-xl font-semibold mb-3">Detajet e rezervimit</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- Veturë -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Veturë *</mat-label>
        <mat-select formControlName="carId">
          <mat-option *ngFor="let car of cars" [value]="car.id">
            {{ car.carBrandName }} - {{ car.carModel }} ({{ car.licensePlate }})
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Pickup Location -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Pickup Location *</mat-label>
        <mat-select formControlName="pickupLocationId">
          <mat-option *ngFor="let loc of locations" [value]="loc.id">
            {{ loc.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Dropoff Location -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Dropoff Location *</mat-label>
        <mat-select formControlName="dropoffLocationId">
          <mat-option *ngFor="let loc of locations" [value]="loc.id">
            {{ loc.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Pickup Date -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Pickup Date *</mat-label>
        <input matInput [matDatepicker]="picker1" formControlName="pickupDate">
        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
        <mat-datepicker #picker1></mat-datepicker>
      </mat-form-field>

      <!-- Dropoff Date -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Dropoff Date *</mat-label>
        <input matInput [matDatepicker]="picker2" formControlName="dropoffDate">
        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
      </mat-form-field>

      <!-- Discount -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Zbritje (€)</mat-label>
        <input type="number" matInput formControlName="discount">
      </mat-form-field>

      <!-- Total Days -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Total ditë</mat-label>
        <input matInput type="number" formControlName="totalDays" readonly>
      </mat-form-field>
    </div>


    <!-- =====================  SEKSIONI 3: EKSTRAT + TOTALI ===================== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

 <div class="bg-gray-50 p-4 border rounded-lg">
  <h3 class="font-semibold mb-2">Shërbime ekstra</h3>

  <div formArrayName="extraServices">
    <div
      *ngFor="let es of extraServices.controls; let i = index"
      [formGroupName]="i"
      class="flex justify-between items-center bg-white p-3 rounded border mb-2"
    >
      <div class="flex items-center gap-3">
        <mat-checkbox
          formControlName="selected"
          (change)="es.get('quantity').enabled = es.get('selected').value"
        ></mat-checkbox>

        <div>
          <div class="font-medium">{{ es.value.name }}</div>
          <div class="text-xs text-gray-500">
            {{ es.value.pricePerDay }} € / ditë
          </div>
        </div>
      </div>

      <mat-form-field appearance="outline" class="w-24">
        <input
          matInput
          type="number"
          min="1"
          formControlName="quantity"
        />
      </mat-form-field>
    </div>
  </div>
</div>



      <!-- Total Summary -->
      <div class="bg-gray-50 rounded-lg border p-4">
        <h2 class="text-lg font-semibold mb-3">Përmbledhje</h2>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Totali veturë:</span>
            <span>{{ form.get('carTotal')?.value | number:'1.2-2' }} €</span>
          </div>
          <div class="flex justify-between">
            <span>Shërbime ekstra:</span>
            <span>{{ form.get('extrasTotal')?.value | number:'1.2-2' }} €</span>
          </div>
          <div class="flex justify-between">
            <span>Totali pa zbritje:</span>
            <span>{{ form.get('totalWithoutDiscount')?.value | number:'1.2-2' }} €</span>
          </div>
          <div class="flex justify-between">
            <span>Zbritja:</span>
            <span>- {{ form.get('discount')?.value }} €</span>
          </div>

          <hr class="my-2">

          <div class="flex justify-between text-base font-semibold">
            <span>Totali final:</span>
            <span>{{ form.get('totalPrice')?.value | number:'1.2-2' }} €</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Notes -->
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>Shënime</mat-label>
      <textarea matInput rows="3" formControlName="notes"></textarea>
    </mat-form-field>

    <!-- Buttons -->
    <div class="flex justify-end gap-4 pt-4">
      <button mat-button type="button" (click)="cancel()">Anulo</button>
      <button mat-flat-button color="primary" type="submit">
        {{ isEdit ? 'Ruaj ndryshimet' : 'Krijo rezervim' }}
      </button>
    </div>

  </form>
</div>
